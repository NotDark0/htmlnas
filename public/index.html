<!DOCTYPE html>
<html>
<head>
  <title>Web NAS - File Manager</title>
  <meta charset="utf-8" />
  <style>
    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: 30px auto;
      background: #f7f7f7;
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
      background-color: #0d1117;
    }
    .top-bar {
      display: grid;
      grid-template-columns: 1fr auto 1fr; /* left spacer, centered title, right user */
      align-items: center;
      padding: 16px 24px;
      background-color: #161b22;
      gap: 12px;
      border-radius: 8px;
    }
    .top-left {
  /* intentionally empty */
    }
    .welcome-title {
  justify-self: center;         /* center horizontally inside the middle column */
  margin: 0;
  font-weight: bold;
  font-size: 40px;
  color: white;
  white-space: nowrap;          /* avoid wrapping */
  overflow: hidden;
  text-overflow: ellipsis;     /* if it's too long, show ... instead of breaking layout */
  max-width: min(60vw, 420px); /* prevents overlap on very small screens */
}
    .account { font-weight: bolder; text-align: right; margin-left: 400px;}
    .logout { background:#ff5e5e;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer; margin-left: 6px;}
    .logout:hover { background:#e04a4a }
    .controls { display:flex; gap:8px; align-items:center; text-align: center; }
    .upload-btn, .create-folder-btn { padding:6px 10px;border-radius:6px;border: none;background:#3b82f6;color:white; cursor:pointer; text-align: center; margin-left: 6px; font-weight: bold;}
    .upload-btn:hover, .create-folder-btn:hover { opacity:0.9 }

    .breadcrumb { margin: 8px 0; color: #ffffff; margin-left: 6px; font-weight: bold;}
    .breadcrumb span { cursor:pointer; color: white;}

    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      background-color: #161b22;
    }

    .panel {
      background:#161b22;
      padding:12px;
      border-radius:8px;
    }

    ul { list-style:none;padding:0;margin:0; }
    li {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:8px 10px;
      border-radius:6px;
      margin:6px 0;
      transition: background .15s;
      position:relative;
    }
    li:hover { background:#3b82f6; }
    .left { display:flex; gap:10px; align-items:center; }

    .actions { display:flex; gap:6px; opacity:0; transition: opacity .12s; }
    li:hover .actions { opacity:1; }

    .btn { border:none; padding:6px 8px; border-radius:6px; cursor:pointer; background:#ddd }
    .btn:hover { background:#ccc }

    .folder-icon { font-weight:bold; font-size:24px; color:#1e3a8a }
    .file-icon { color:#374151 }

    .small { font-size:12px; color:#666; margin-left:8px }

    .file-container {
      position: relative;
      display: inline-block;
    }

    /* Hide the real input but keep it clickable */
    .file-input {
      opacity: 0;
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
      z-index: 2;
    }

    /* Custom visible layer */
    .file-label {
      display: inline-block;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.2s;
      user-select: none;
      padding:6px 10px;
      border-radius:6px;
      border: none;
      background:#3b82f6;
      color:white;
    }

    .file-label:hover {
      background-color: #0056b3;
    }
    .new-content-user-container {
  justify-self: end;
  position: relative;
  display: flex;
  align-items: center;
}

.new-content-username {
  font-weight: 600;
  cursor: pointer;
  padding: 8px 14px;
  border-radius: 8px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
  font-size: 20px;
  color: #ffffff;
  white-space: nowrap;
}

.new-content-username:hover {
  background: #3b82f6;
}

.new-content-dropdown {
  position: absolute;
  top: 120%;
  right: 0;
  background: #292e35;
  border-radius: 10px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  padding: 10px;
  opacity: 0;
  pointer-events: none;
  transform: translateY(-10px);
  transition: all 0.25s ease;
  display: flex;
  flex-direction: column;
  min-width: 150px;
  z-index: 10;
}

.new-content-dropdown.show {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

.new-content-dropdown button {
  border: none;
  border-radius: 6px;
  padding: 8px 10px;
  text-align: left;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s ease;
  margin: 4px 0;
  background: #3b3f46;
  color: white;
}

.new-content-dropdown button:hover {
  background: #4f545b;
}

.new-content-logout {
  background: #ff5f5f;
  color: white;
}

.new-content-logout:hover {
  background: #e63946;
}
  </style>
</head>
<body>
  <div class="top-bar">
  <div class="top-left"></div> <!-- empty spacer -->
  <h1 class="welcome-title">Welcome</h1>
  <div class="new-content-user-container">
    <div class="new-content-username" id="accountName">Error001</div>
    <div class="new-content-dropdown" id="userDropdown">
      <button>Account</button>
      <button class="new-content-logout" onclick="logout()">Logout</button>
    </div>
  </div>
</div>


  <div class="grid">
    <div class="panel">
        <div class="controls">
            <div>
                <form id="uploadForm" style="display:inline-flex; align-items: right;" enctype="multipart/form-data" method="POST" action="/upload">
                <label class="upload-btn" for="fileInput">Files</label>
                <input type="file" id="fileInput" name="file" required style="display:none;" />
                <input type="hidden" name="path" id="uploadPath" value="">
                <button class="upload-btn" type="submit">Upload</button>
                <button class="upload-btn" onclick="createFolder()">New Folder</button>
                <div class="breadcrumb" id="breadcrumb"></div>
                </form>
            </div>
    </div>
      <ul id="folderList"></ul>
      <ul id="fileList"></ul>
    </div>
  </div>

  <script>
    let currentPath = ''; // relative path inside user's folder
    const username = document.getElementById('accountName');
    const dropdown = document.getElementById('userDropdown');

    async function loadContents() {
      try {
        const res = await fetch('/list?path=' + encodeURIComponent(currentPath));
        if (!res.ok) {
          const t = await res.text();
          alert('Error listing: ' + t);
          return;
        }
        const data = await res.json();
        document.getElementById('accountName').textContent = data.user || 'e';
        renderBreadcrumb(data.path || '');
        renderFolders(data.folders || []);
        renderFiles(data.files || []);
        // set hidden upload path
        document.getElementById('uploadPath').value = currentPath;
      } catch (err) {
        alert('Error: ' + err.message);
      }
    }

    username.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent the click from bubbling to the document
      dropdown.classList.toggle('show');
    });

    // Close dropdown when clicking anywhere else
    document.addEventListener('click', (e) => {
      if (!dropdown.contains(e.target) && !username.contains(e.target)) {
        dropdown.classList.remove('show');
      }
    });

    function renderBreadcrumb(rel) {
      const container = document.getElementById('breadcrumb');
      const parts = rel ? rel.split('/').filter(Boolean) : [];
      let html = `<span onclick="goToPath('')">home</span>`;
      let acc = '';
      for (let i = 0; i < parts.length; i++) {
        acc = acc ? (acc + '/' + parts[i]) : parts[i];
        html += ' / <span onclick="goToPath(\'' + encodeURIComponent(acc) + '\')">' + parts[i] + '</span>';
      }
      container.innerHTML = html;
    }

    function renderFolders(folders) {
      const ul = document.getElementById('folderList');
      if (folders.length === 0) { ul.innerHTML = '<li class="small"> </li>'; return; }
      ul.innerHTML = folders.map(name => `
        <li>
          <div class="left">
            <div class="folder-icon">üìÅ</div>
            <div>
              <div style="cursor:pointer" onclick="openFolder('${encodeURIComponent(name)}')">${name}</div>
            </div>
          </div>
          <div class="actions">
            <button class="btn" onclick="enterFolder('${encodeURIComponent(name)}')">Open</button>
            <button class="btn" onclick="renameFolderPrompt('${encodeURIComponent(name)}')">‚úèÔ∏è</button>
            <button class="btn" onclick="deleteFolder('${encodeURIComponent(name)}')">üóëÔ∏è</button>
          </div>
        </li>
      `).join('');
    }

    function renderFiles(files) {
      const ul = document.getElementById('fileList');
      if (files.length === 0) { ul.innerHTML = '<li class="small"> </li>'; return; }
      ul.innerHTML = files.map(name => `
        <li>
          <div class="left">
            <div class="file-icon">üìÑ</div>
            <div>${name}</div>
          </div>
          <div class="actions">
            <form style="display:inline" method="GET" action="/download">
              <input type="hidden" name="path" value="${currentPath}">
              <input type="hidden" name="filename" value="${name}">
              <button class="btn" type="submit">‚¨áÔ∏è</button>
            </form>

            <form style="display:inline" method="POST" action="/delete-file">
              <input type="hidden" name="path" value="${currentPath}">
              <input type="hidden" name="filename" value="${name}">
              <button class="btn" type="submit">üóëÔ∏è</button>
            </form>

            <button class="btn" onclick="renameFilePrompt('${encodeURIComponent(name)}')">‚úèÔ∏è</button>
          </div>
        </li>
      `).join('');
    }

    // navigation helpers
    function goToPath(encodedPath) {
      currentPath = decodeURIComponent(encodedPath || '');
      loadContents();
    }
    function openFolder(encodedName) { // open inside current folder
      const name = decodeURIComponent(encodedName);
      currentPath = currentPath ? (currentPath + '/' + name) : name;
      loadContents();
    }
    function enterFolder(encodedName) { openFolder(encodedName); }

    // folder actions
    function createFolder() {
      const name = prompt('New folder name:');
      if (!name) return;
      // send via form post so server redirect keeps us on index; but we want SPA behavior so use fetch then reload
      const form = new FormData();
      form.append('path', currentPath);
      form.append('name', name);
      fetch('/create-folder', { method: 'POST', body: form })
        .then(resp => {
          if (!resp.ok) return resp.text().then(t => Promise.reject(t));
          loadContents();
        })
        .catch(err => alert('Error creating folder: ' + err));
    }

    function deleteFolder(encodedName) {
      const name = decodeURIComponent(encodedName);
      if (!confirm('Delete folder "' + name + '" and all its contents?')) return;
      const form = new FormData();
      form.append('path', currentPath);
      form.append('name', name);
      fetch('/delete-folder', { method: 'POST', body: form })
        .then(resp => {
          if (!resp.ok) return resp.text().then(t => Promise.reject(t));
          loadContents();
        })
        .catch(err => alert('Error deleting folder: ' + err));
    }

    function renameFolderPrompt(encodedOld) {
      const oldName = decodeURIComponent(encodedOld);
      const newName = prompt('Rename folder "' + oldName + '" to:');
      if (!newName) return;
      const form = new FormData();
      form.append('path', currentPath);
      form.append('oldName', oldName);
      form.append('newName', newName);
      fetch('/rename-folder', { method: 'POST', body: form })
        .then(resp => {
          if (!resp.ok) return resp.text().then(t => Promise.reject(t));
          loadContents();
        })
        .catch(err => alert('Error renaming folder: ' + err));
    }

    // file actions
    function renameFilePrompt(encodedOld) {
      const oldName = decodeURIComponent(encodedOld);
      const newName = prompt('Rename file "' + oldName + '" to:');
      if (!newName) return;
      const form = new FormData();
      form.append('path', currentPath);
      form.append('oldName', oldName);
      form.append('newName', newName);
      fetch('/rename-file', { method: 'POST', body: form })
        .then(resp => {
          if (!resp.ok) return resp.text().then(t => Promise.reject(t));
          loadContents();
        })
        .catch(err => alert('Error renaming file: ' + err));
    }

    // upload form: send path as hidden input - already set when loading
    document.getElementById('uploadForm').addEventListener('submit', function(e){
      // leave normal submit to allow large file streaming; but ensure path is set
      document.getElementById('uploadPath').value = currentPath;
    });

    function logout() {
        dropdown.classList.remove('show'); 
        window.location.href = '/logout';
    }

    // initial load
    loadContents();
  </script>
</body>
</html>
